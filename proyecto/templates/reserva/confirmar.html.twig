{% extends 'layout/base.html.twig' %}

{% block title %}Confirmar Reserva{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row g-4">
        <!-- Columna izquierda: Información de la Máquina -->
        <div class="col-md-6">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h1 class="card-title text-primary text-center fw-bold fs-2">Confirmar Reserva</h1>
                    <h2 class="text-primary text-center fw-semibold fs-4">{{ maquina.nombre }}</h2>
                    {% if maquina.imagenes is not empty %}
                        <img src="{{ asset('images/' ~ maquina.imagenes[0]) }}" alt="Imagen de la máquina" class="img-fluid rounded mb-3 d-block mx-auto" style="object-fit:cover; max-height:300px;">
                    {% else %}
                        <p class="text-muted">No hay imagen disponible.</p>
                    {% endif %}
                    <p><strong>Descripción:</strong> {{ maquina.descripcion }}</p>
                </div>
            </div>
        </div>

        <!-- Columna derecha: Datos de la Reserva y Opciones de Pago -->
        <div class="col-md-6">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h3 class="text-primary text-center fw-semibold fs-5 mb-3">Datos de la reserva</h3>
                    <p><strong>Fechas:</strong> {{ reserva.fechaInicio|date('d/m/Y') }} – {{ reserva.fechaFin|date('d/m/Y') }}</p>
                    <p><strong>Días:</strong> {{ reserva.fechaInicio.diff(reserva.fechaFin).days + (reserva.fechaInicio.format('Y-m-d') == reserva.fechaFin.format('Y-m-d') ? 1 : 0) }}</p>

                    {% if recargoMontoDisplay > 0 %}
                        <p><strong>Costo base:</strong> ${{ (costoFinalDisplay - recargoMontoDisplay)|number_format(2, ',', '.') }}</p>
                        <p><strong>Recargo por valoración (cliente con {{ valoracionPromedio|number_format(1) }} estrellas):</strong> ${{ recargoMontoDisplay|number_format(2, ',', '.') }}</p>
                    {% else %}
                        <p><strong>Sin recargo por valoración (cliente con {{ valoracionPromedio|number_format(1) }} estrellas)</strong></p>
                    {% endif %}

                    <p>
                        <strong>Costo total:</strong>
                        <span class="fs-4 fw-bold text-danger">${{ costoFinalDisplay|number_format(2, ',', '.') }}</span>
                    </p>

                    <p>Reembolso si cancelas antes del {{ reserva.fechaReembolsoPenalizado|date('d/m/Y') }} : ${{ reserva.montoReembolso|number_format(2, ',', '.') }}</p>
                    <p>Reembolso si cancelas después del {{ reserva.fechaReembolsoPenalizado|date('d/m/Y') }} : ${{ reserva.reembolsoPenalizado|number_format(2, ',', '.') }}</p>

                    <div class="mt-4">
                        <button class="btn btn-warning w-100 mb-2">Aplicar cupón</button>
                        <div id="walletBrick_container" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script>
        const publicKey = '{{ MERCADOPAGO_PUBLIC_KEY|default('APP_USR-a8939531-6298-4a18-8a19-820c941ab804') }}';
        const preferenceId = '{{ preferenceId|default('') }}';

        if (publicKey && preferenceId) {
            const mp = new MercadoPago(publicKey, { locale: 'es-AR' });
            mp.bricks().create("wallet", "walletBrick_container", {
                initialization: { preferenceId: preferenceId },
                callbacks: {
                    onSubmit: () => {
                        salidaForzada = false;
                        return Promise.resolve();
                    },
                    onReady: () => { console.log('Wallet Brick listo para usar.'); },
                    onError: (error) => {
                        console.error('Error al inicializar Wallet Brick:', error);
                        const container = document.getElementById('walletBrick_container');
                        if (container) {
                            container.innerHTML = '<p class="text-danger">No se pudo cargar el método de pago. Inténtalo de nuevo más tarde.</p>';
                        }
                    }
                }
            });
        } else {
            console.error("Error: No se pudo cargar Mercado Pago. Falta la Public Key o el Preference ID.");
            const container = document.getElementById('walletBrick_container');
            if (container) {
                container.innerHTML = '<p class="text-danger">No se pudo cargar el método de pago. Por favor, asegúrate de que las claves de Mercado Pago estén configuradas correctamente.</p>';
            }
        }
        let salidaForzada = true;
        window.addEventListener('beforeunload', (e) => {
            if (salidaForzada) {
                navigator.sendBeacon('/reserva/eliminar/{{reserva.id}}');
            }
        });
    </script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}
